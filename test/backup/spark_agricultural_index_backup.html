<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²ƒåœŸè§„åˆ’å¸ˆ - Sparkå†œä¸šåˆ†æç³»ç»Ÿ</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        .navbar-brand {
            font-weight: bold;
            color: #2E8B57 !important;
        }
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #2E8B57, #32CD32);
            color: white;
            font-weight: bold;
        }
        .chart-container {
            height: 400px;
            margin: 20px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ready { background-color: #28a745; }
        .status-loading { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .btn-spark { 
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            border: none;
            color: white;
        }
        .btn-spark:hover {
            background: linear-gradient(135deg, #4ECDC4, #FF6B6B);
            color: white;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-seedling me-2"></i>æ²ƒåœŸè§„åˆ’å¸ˆ - Sparkå†œä¸šåˆ†æç³»ç»Ÿ
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span id="systemStatus" class="status-indicator status-loading"></span>
                    <span id="statusText">ç³»ç»ŸçŠ¶æ€: æœªåˆå§‹åŒ–</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cogs me-2"></i>ç³»ç»Ÿæ§åˆ¶é¢æ¿
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <button id="initSystemBtn" class="btn btn-spark btn-lg me-3">
                                    <i class="fas fa-rocket me-2"></i>åˆå§‹åŒ–Sparkç³»ç»Ÿ
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div id="systemInfo" class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    è¯·å…ˆåˆå§‹åŒ–Sparkç³»ç»Ÿä»¥è¿æ¥MySQLæ•°æ®åº“
                                </div>
                            </div>
                        </div>
                        
                        <!-- åˆ†ææ§åˆ¶åŒºåŸŸ -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <button id="runAnalysisBtn" class="btn btn-success btn-lg w-100" disabled>
                                    <i class="fas fa-chart-line me-2"></i>è¿è¡Œç»¼åˆåˆ†æ
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div id="analysisInfo" class="alert alert-secondary">
                                    <i class="fas fa-info-circle me-2"></i>
                                    è¯·å…ˆåˆå§‹åŒ–ç³»ç»Ÿï¼Œç„¶åè¿è¡Œç»¼åˆåˆ†æ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        <ul class="nav nav-tabs" id="analysisTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="climate-tab" data-bs-toggle="tab" data-bs-target="#climate" type="button">
                    <i class="fas fa-cloud-sun me-2"></i>æ°”å€™è¶‹åŠ¿åˆ†æ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="soil-tab" data-bs-toggle="tab" data-bs-target="#soil" type="button">
                    <i class="fas fa-mountain me-2"></i>åœŸå£¤åˆ†å¸ƒåˆ†æ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="crop-tab" data-bs-toggle="tab" data-bs-target="#crop" type="button">
                    <i class="fas fa-wheat-awn me-2"></i>ä½œç‰©é€‚å®œæ€§åˆ†æ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="zoning-tab" data-bs-toggle="tab" data-bs-target="#zoning" type="button">
                    <i class="fas fa-map me-2"></i>åŒºåˆ’ä¼˜åŒ–å»ºè®®
                </button>
            </li>
        </ul>

        <!-- åˆ†æç»“æœå†…å®¹ -->
        <div class="tab-content" id="analysisTabContent">
            <!-- æ°”å€™è¶‹åŠ¿åˆ†æ -->
            <div class="tab-pane fade show active" id="climate" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">æ¸©åº¦å˜åŒ–è¶‹åŠ¿</div>
                            <div class="card-body">
                                <div id="tempTrendChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">æœˆåº¦é™æ°´æ¨¡å¼</div>
                            <div class="card-body">
                                <div id="precipPatternChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">åœ°åŒºæ°”å€™åˆ†å¸ƒçƒ­åŠ›å›¾</div>
                            <div class="card-body">
                                <div id="climateHeatmapChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åœŸå£¤åˆ†å¸ƒåˆ†æ -->
            <div class="tab-pane fade" id="soil" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">åœŸå£¤ç±»å‹åˆ†å¸ƒ</div>
                            <div class="card-body">
                                <div id="soilTypePieChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">pHå€¼åˆ†å¸ƒç»Ÿè®¡</div>
                            <div class="card-body">
                                <div id="phDistChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">å¿å¸‚åœŸå£¤è´¨é‡æ’å</div>
                            <div class="card-body">
                                <div id="countyQualityChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä½œç‰©é€‚å®œæ€§åˆ†æ -->
            <div class="tab-pane fade" id="crop" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">ä½œç‰©é€‚å®œæ€§åˆ†å¸ƒ</div>
                            <div class="card-body">
                                <div id="suitabilityDistChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">ä½œç‰©ç§æ¤ä¼˜åŠ¿é›·è¾¾å›¾</div>
                            <div class="card-body">
                                <div id="cropRadarChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">ç§æ¤é™åˆ¶å› å­åˆ†æ</div>
                            <div class="card-body">
                                <div id="limitingFactorsChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŒºåˆ’ä¼˜åŒ–å»ºè®® -->
            <div class="tab-pane fade" id="zoning" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">åŒºåˆ’ä¼˜åŒ–åˆ†å¸ƒå›¾</div>
                            <div class="card-body">
                                <div id="zoningScatterChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">æœ€ä½³ç§æ¤åŒºåŸŸåˆ†å¸ƒ</div>
                            <div class="card-body">
                                <div id="optimizationMapChart" class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let charts = {};
        let systemInitialized = false;
        let analysisCompleted = false;

        // åˆå§‹åŒ–å›¾è¡¨å®¹å™¨
        function initCharts() {
            const chartIds = [
                'tempTrendChart', 'precipPatternChart', 'climateHeatmapChart',
                'soilTypePieChart', 'phDistChart', 'countyQualityChart',
                'suitabilityDistChart', 'cropRadarChart', 'limitingFactorsChart',
                'zoningScatterChart', 'optimizationMapChart'
            ];

            chartIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    charts[id] = echarts.init(element);
                }
            });
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus(status, message) {
            const statusIndicator = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');
            
            statusIndicator.className = 'status-indicator';
            
            switch(status) {
                case 'ready':
                    statusIndicator.classList.add('status-ready');
                    break;
                case 'loading':
                    statusIndicator.classList.add('status-loading');
                    break;
                case 'error':
                    statusIndicator.classList.add('status-error');
                    break;
            }
            
            statusText.textContent = `ç³»ç»ŸçŠ¶æ€: ${message}`;
        }

        // åˆå§‹åŒ–Sparkç³»ç»Ÿ
        async function initializeSystem() {
            const btn = document.getElementById('initSystemBtn');
            const info = document.getElementById('systemInfo');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>åˆå§‹åŒ–ä¸­...';
            updateSystemStatus('loading', 'åˆå§‹åŒ–ä¸­');
            
            try {
                const response = await fetch('/api/system/initialize', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    systemInitialized = true;
                    updateSystemStatus('ready', 'ç³»ç»Ÿå°±ç»ª');
                    info.className = 'alert alert-success';
                    const summary = result.data_summary;
                    info.innerHTML = `<i class="fas fa-check-circle me-2"></i>Sparkç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸï¼æ•°æ®æ‘˜è¦: æ¸©åº¦${summary.temperature_records || 0}æ¡, é™æ°´${summary.precipitation_records || 0}æ¡, åœŸå£¤${summary.soil_records || 0}æ¡, ä½œç‰©${summary.crop_types || 0}ç§`;
                    
                    document.getElementById('runAnalysisBtn').disabled = false;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                updateSystemStatus('error', 'åˆå§‹åŒ–å¤±è´¥');
                info.className = 'alert alert-danger';
                info.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-rocket me-2"></i>é‡æ–°åˆå§‹åŒ–';
            }
        }

        // è¿è¡Œç»¼åˆåˆ†æ
        async function runAnalysis() {
            const btn = document.getElementById('runAnalysisBtn');
            const info = document.getElementById('analysisInfo');
            
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!btn) {
                console.error('âŒ runAnalysisBtn å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            if (!info) {
                console.error('âŒ analysisInfo å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>åˆ†æä¸­...';
            info.className = 'alert alert-info';
            info.innerHTML = '<i class="fas fa-cog fa-spin me-2"></i>æ­£åœ¨è¿è¡ŒSparkç»¼åˆåˆ†æï¼Œè¯·ç¨å€™...';
            
            // è®¾ç½®30ç§’è¶…æ—¶
            const timeoutId = setTimeout(() => {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-chart-line me-2"></i>é‡æ–°åˆ†æ';
                }
                if (info) {
                    info.className = 'alert alert-warning';
                    info.innerHTML = '<i class="fas fa-clock me-2"></i>åˆ†æè¶…æ—¶ï¼Œè¯·é‡è¯•æˆ–åˆ·æ–°é¡µé¢';
                }
            }, 30000);
            
            try {
                console.log('ğŸš€ å¼€å§‹è¿è¡Œåˆ†æ...');
                const response = await fetch('/api/analysis/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('ğŸ“Š åˆ†æç»“æœ:', result);
                
                if (result.status === 'success') {
                    analysisCompleted = true;
                    info.className = 'alert alert-success';
                    info.innerHTML = `<i class="fas fa-check-circle me-2"></i>åˆ†æå®Œæˆï¼æ‰§è¡Œæ—¶é—´: ${result.statistics.execution_time}ç§’`;
                    
                    console.log('ğŸ“ˆ å¼€å§‹åŠ è½½æ‰€æœ‰å›¾è¡¨...');
                    
                    // ç«‹å³æ›´æ–°æŒ‰é’®çŠ¶æ€
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-chart-line me-2"></i>é‡æ–°åˆ†æ';
                    
                    // åŠ è½½å›¾è¡¨
                    try {
                        await loadAllCharts();
                        info.innerHTML += '<br><i class="fas fa-chart-bar me-2"></i>å›¾è¡¨åŠ è½½å®Œæˆï¼';
                    } catch (chartError) {
                        console.error('å›¾è¡¨åŠ è½½å¤±è´¥:', chartError);
                        info.innerHTML += '<br><i class="fas fa-exclamation-triangle me-2"></i>å›¾è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                    }
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('âŒ åˆ†æå¤±è´¥:', error);
                clearTimeout(timeoutId); // ç¡®ä¿æ¸…é™¤è¶…æ—¶
                info.className = 'alert alert-danger';
                info.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>åˆ†æå¤±è´¥: ${error.message}`;
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-chart-line me-2"></i>é‡æ–°åˆ†æ';
            }
        }

        // æ£€æŸ¥åˆ†æçŠ¶æ€
        async function checkAnalysisStatus() {
            try {
                const response = await fetch('/api/echarts/soil_analysis');
                const result = await response.json();
                
                if (result.status === 'success') {
                    console.log('âœ… æ£€æµ‹åˆ°åˆ†æå·²å®Œæˆï¼Œå¼€å§‹åŠ è½½å›¾è¡¨...');
                    analysisCompleted = true;
                    
                    const info = document.getElementById('analysisInfo');
                    const btn = document.getElementById('runAnalysisBtn');
                    
                    if (info) {
                        info.className = 'alert alert-success';
                        info.innerHTML = '<i class="fas fa-check-circle me-2"></i>åˆ†æå®Œæˆï¼æ­£åœ¨åŠ è½½å›¾è¡¨...';
                    }
                    
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-chart-line me-2"></i>é‡æ–°åˆ†æ';
                    }
                    
                    await loadAllCharts();
                    
                    if (info) {
                        info.innerHTML += '<br><i class="fas fa-chart-bar me-2"></i>å›¾è¡¨åŠ è½½å®Œæˆï¼';
                    }
                    
                    return true;
                }
            } catch (error) {
                console.log('æ£€æŸ¥åˆ†æçŠ¶æ€å¤±è´¥:', error);
            }
            return false;
        }

        // åŠ è½½æ‰€æœ‰å›¾è¡¨
        async function loadAllCharts() {
            console.log('ğŸš€ å¼€å§‹åŠ è½½æ‰€æœ‰å›¾è¡¨...');
            try {
                await loadClimateCharts();
                console.log('âœ… æ°”å€™å›¾è¡¨åŠ è½½å®Œæˆ');
                
                await loadSoilCharts();
                console.log('âœ… åœŸå£¤å›¾è¡¨åŠ è½½å®Œæˆ');
                
                await loadCropCharts();
                console.log('âœ… ä½œç‰©å›¾è¡¨åŠ è½½å®Œæˆ');
                
                await loadZoningCharts();
                console.log('âœ… åŒºåˆ’å›¾è¡¨åŠ è½½å®Œæˆ');
                
                console.log('ğŸ‰ æ‰€æœ‰å›¾è¡¨åŠ è½½å®Œæˆï¼');
            } catch (error) {
                console.error('âŒ å›¾è¡¨åŠ è½½è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
            }
        }

        // åŠ è½½æ°”å€™å›¾è¡¨
        async function loadClimateCharts() {
            try {
                const response = await fetch('/api/echarts/climate_trends');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const charts_data = result.charts;
                    
                    // æ¸©åº¦è¶‹åŠ¿å›¾
                    charts.tempTrendChart.setOption({
                        title: { text: charts_data.temperature_trend.title },
                        tooltip: { trigger: 'axis' },
                        legend: { data: ['å¹³å‡æ¸©åº¦', 'æœ€é«˜æ¸©åº¦', 'æœ€ä½æ¸©åº¦'] },
                        xAxis: { data: charts_data.temperature_trend.xAxis },
                        yAxis: { type: 'value', name: 'æ¸©åº¦(Â°C)' },
                        series: charts_data.temperature_trend.series
                    });
                    
                    // å¹´åº¦è¶‹åŠ¿å›¾
                    if (charts_data.annual_trend && charts_data.annual_trend.xAxis.length > 0) {
                        charts.precipPatternChart.setOption({
                            title: { text: charts_data.annual_trend.title },
                            tooltip: { trigger: 'axis' },
                            xAxis: { data: charts_data.annual_trend.xAxis },
                            yAxis: { type: 'value', name: 'æ¸©åº¦(Â°C)' },
                            series: charts_data.annual_trend.series
                        });
                    }
                    
                    // å­£èŠ‚å¯¹æ¯”å›¾
                    if (charts_data.seasonal_comparison && charts_data.seasonal_comparison.data.length > 0) {
                        charts.climateHeatmapChart.setOption({
                            title: { text: charts_data.seasonal_comparison.title },
                            tooltip: { trigger: 'item' },
                            legend: { orient: 'vertical', left: 'left' },
                            series: [{
                                type: 'pie',
                                radius: '50%',
                                data: charts_data.seasonal_comparison.data,
                                emphasis: { itemStyle: { shadowBlur: 10 } }
                            }]
                        });
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ°”å€™å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½åœŸå£¤å›¾è¡¨
        async function loadSoilCharts() {
            try {
                console.log('ğŸŒ± å¼€å§‹åŠ è½½åœŸå£¤å›¾è¡¨...');
                
                // ç¡®ä¿å›¾è¡¨å®¹å™¨å·²åˆå§‹åŒ–
                if (!charts.soilTypePieChart || !charts.phDistChart || !charts.countyQualityChart) {
                    console.error('âŒ åœŸå£¤å›¾è¡¨å®¹å™¨æœªåˆå§‹åŒ–');
                    return;
                }
                
                const response = await fetch('/api/echarts/soil_analysis');
                const result = await response.json();
                
                console.log('ğŸ“Š åœŸå£¤åˆ†æAPIå“åº”:', result);
                
                if (result.status === 'success') {
                    const charts_data = result.charts;
                    console.log('ğŸ“ˆ åœŸå£¤å›¾è¡¨æ•°æ®:', Object.keys(charts_data));
                    
                    // åœŸå£¤ç±»å‹é¥¼å›¾
                    if (charts_data.soil_type_pie && charts_data.soil_type_pie.data && charts_data.soil_type_pie.data.length > 0) {
                        console.log('ğŸ¥§ è®¾ç½®åœŸå£¤ç±»å‹é¥¼å›¾ï¼Œæ•°æ®ç‚¹:', charts_data.soil_type_pie.data.length);
                        console.log('ğŸ“Š åœŸå£¤ç±»å‹æ•°æ®:', charts_data.soil_type_pie.data);
                        
                        const pieOption = {
                            title: { 
                                text: 'æ¹–å—çœåœŸå£¤ç±»å‹åˆ†å¸ƒ',
                                left: 'center',
                                textStyle: { fontSize: 16, fontWeight: 'bold' }
                            },
                            tooltip: { 
                                trigger: 'item',
                                formatter: '{a} <br/>{b}: {c}ä¸ªæ ·æœ¬ ({d}%)'
                            },
                            legend: { 
                                orient: 'vertical', 
                                left: 'left',
                                top: 'middle',
                                textStyle: { fontSize: 12 }
                            },
                            series: [{
                                name: 'åœŸå£¤ç±»å‹',
                                type: 'pie',
                                radius: ['30%', '70%'],
                                center: ['60%', '50%'],
                                data: charts_data.soil_type_pie.data,
                                emphasis: { 
                                    itemStyle: { 
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                },
                                label: {
                                    show: true,
                                    formatter: '{b}\n{c}ä¸ª'
                                },
                                labelLine: {
                                    show: true
                                }
                            }]
                        };
                        
                        charts.soilTypePieChart.setOption(pieOption);
                        console.log('âœ… åœŸå£¤ç±»å‹é¥¼å›¾è®¾ç½®å®Œæˆ');
                    } else {
                        console.warn('âš ï¸ åœŸå£¤ç±»å‹æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
                    }
                    
                    // pHåˆ†å¸ƒå›¾
                    if (charts_data.ph_distribution && charts_data.ph_distribution.xAxis && charts_data.ph_distribution.xAxis.length > 0) {
                        console.log('ğŸ“Š è®¾ç½®pHåˆ†å¸ƒå›¾ï¼ŒXè½´æ•°æ®:', charts_data.ph_distribution.xAxis.length);
                        console.log('ğŸ“ˆ pHåˆ†å¸ƒæ•°æ®:', charts_data.ph_distribution);
                        
                        const phOption = {
                            title: { 
                                text: 'æ¹–å—çœåœŸå£¤pHå€¼åˆ†å¸ƒ',
                                left: 'center',
                                textStyle: { fontSize: 16, fontWeight: 'bold' }
                            },
                            tooltip: { 
                                trigger: 'axis',
                                axisPointer: { type: 'shadow' },
                                formatter: '{a}<br/>{b}: {c}ä¸ªæ ·æœ¬'
                            },
                            xAxis: { 
                                type: 'category',
                                data: charts_data.ph_distribution.xAxis,
                                axisLabel: { 
                                    rotate: 0,
                                    fontSize: 12
                                }
                            },
                            yAxis: { 
                                type: 'value', 
                                name: 'æ ·æœ¬æ•°é‡',
                                nameLocation: 'middle',
                                nameGap: 50,
                                nameTextStyle: { fontSize: 12 }
                            },
                            series: charts_data.ph_distribution.series.map(s => ({
                                ...s,
                                itemStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        {offset: 0, color: '#4ECDC4'},
                                        {offset: 1, color: '#44A08D'}
                                    ])
                                },
                                emphasis: {
                                    itemStyle: {
                                        color: '#2E8B57'
                                    }
                                }
                            }))
                        };
                        
                        charts.phDistChart.setOption(phOption);
                        console.log('âœ… pHåˆ†å¸ƒå›¾è®¾ç½®å®Œæˆ');
                    } else {
                        console.warn('âš ï¸ pHåˆ†å¸ƒæ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
                    }
                    
                    // å¿å¸‚è´¨é‡æ’å
                    if (charts_data.county_quality_ranking && charts_data.county_quality_ranking.xAxis && charts_data.county_quality_ranking.xAxis.length > 0) {
                        console.log('ğŸ† è®¾ç½®å¿å¸‚è´¨é‡æ’åï¼Œå¿å¸‚æ•°é‡:', charts_data.county_quality_ranking.xAxis.length);
                        console.log('ğŸ“Š å¿å¸‚æ’åæ•°æ®:', charts_data.county_quality_ranking);
                        
                        const qualityOption = {
                            title: { 
                                text: 'æ¹–å—çœå¿å¸‚åœŸå£¤è´¨é‡æ’å',
                                left: 'center',
                                textStyle: { fontSize: 16, fontWeight: 'bold' }
                            },
                            tooltip: { 
                                trigger: 'axis',
                                axisPointer: { type: 'shadow' },
                                formatter: '{a}<br/>{b}: {c}åˆ†'
                            },
                            xAxis: { 
                                type: 'category',
                                data: charts_data.county_quality_ranking.xAxis,
                                axisLabel: { 
                                    rotate: 45,
                                    interval: 0,
                                    fontSize: 11
                                }
                            },
                            yAxis: { 
                                type: 'value', 
                                name: 'åœŸå£¤è´¨é‡è¯„åˆ†',
                                nameLocation: 'middle',
                                nameGap: 50,
                                nameTextStyle: { fontSize: 12 }
                            },
                            series: charts_data.county_quality_ranking.series.map(s => ({
                                ...s,
                                itemStyle: {
                                    color: function(params) {
                                        // æ ¹æ®æ’åè®¾ç½®ä¸åŒé¢œè‰²
                                        const colors = ['#FFD700', '#C0C0C0', '#CD7F32', '#4ECDC4', '#45B7D1'];
                                        return colors[params.dataIndex % colors.length];
                                    }
                                },
                                emphasis: {
                                    itemStyle: {
                                        color: '#FF6B6B'
                                    }
                                },
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: '{c}',
                                    fontSize: 10
                                }
                            }))
                        };
                        
                        charts.countyQualityChart.setOption(qualityOption);
                        console.log('âœ… å¿å¸‚è´¨é‡æ’åå›¾è®¾ç½®å®Œæˆ');
                    } else {
                        console.warn('âš ï¸ å¿å¸‚è´¨é‡æ’åæ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
                    }
                    
                    console.log('âœ… åœŸå£¤å›¾è¡¨åŠ è½½å®Œæˆ');
                } else {
                    console.error('åœŸå£¤åˆ†æAPIè¿”å›é”™è¯¯:', result.message);
                }
            } catch (error) {
                console.error('åŠ è½½åœŸå£¤å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½ä½œç‰©å›¾è¡¨
        async function loadCropCharts() {
            try {
                console.log('ğŸŒ¾ å¼€å§‹åŠ è½½ä½œç‰©å›¾è¡¨...');
                const response = await fetch('/api/echarts/crop_suitability');
                const result = await response.json();
                
                console.log('ğŸ“Š ä½œç‰©åˆ†æAPIå“åº”:', result);
                
                if (result.status === 'success') {
                    const charts_data = result.charts;
                    console.log('ğŸ“ˆ ä½œç‰©å›¾è¡¨æ•°æ®:', Object.keys(charts_data));
                    
                    // ä½œç‰©åˆ†ç±»åˆ†å¸ƒé¥¼å›¾
                    if (charts_data.suitability_distribution && charts_data.suitability_distribution.data) {
                        console.log('ğŸ¥§ è®¾ç½®ä½œç‰©åˆ†ç±»é¥¼å›¾ï¼Œæ•°æ®ç‚¹:', charts_data.suitability_distribution.data.length);
                        charts.suitabilityDistChart.setOption({
                            title: { 
                                text: charts_data.suitability_distribution.title || 'æ¹–å—çœä½œç‰©åˆ†ç±»åˆ†å¸ƒ',
                                left: 'center',
                                textStyle: { fontSize: 16, fontWeight: 'bold' }
                            },
                            tooltip: { 
                                trigger: 'item',
                                formatter: '{a} <br/>{b}: {c}ç§ ({d}%)'
                            },
                            legend: { 
                                orient: 'vertical', 
                                left: 'left',
                                top: 'middle'
                            },
                            series: [{
                                name: 'ä½œç‰©åˆ†ç±»',
                                type: 'pie',
                                radius: '60%',
                                data: charts_data.suitability_distribution.data,
                                emphasis: { 
                                    itemStyle: { 
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                },
                                label: {
                                    show: true,
                                    formatter: '{b}: {c}ç§'
                                }
                            }]
                        });
                        console.log('âœ… ä½œç‰©åˆ†ç±»é¥¼å›¾è®¾ç½®å®Œæˆ');
                    }
                    
                    // ä½œç‰©æ¸©åº¦éœ€æ±‚æŸ±çŠ¶å›¾ï¼ˆåŸæœ¬æ˜¯é›·è¾¾å›¾ï¼‰
                    if (charts_data.crop_advantages_radar && charts_data.crop_advantages_radar.xAxis) {
                        console.log('ğŸ“Š è®¾ç½®ä½œç‰©æ¸©åº¦éœ€æ±‚å›¾ï¼Œä½œç‰©æ•°é‡:', charts_data.crop_advantages_radar.xAxis.length);
                        charts.cropRadarChart.setOption({
                            title: { 
                                text: charts_data.crop_advantages_radar.title || 'ä½œç‰©æ¸©åº¦éœ€æ±‚èŒƒå›´',
                                left: 'center',
                                textStyle: { fontSize: 16, fontWeight: 'bold' }
                            },
                            tooltip: { 
                                trigger: 'axis',
                                axisPointer: { type: 'shadow' }
                            },
                            legend: {
                                data: charts_data.crop_advantages_radar.series.map(s => s.name),
                                top: 'bottom'
                            },
                            xAxis: { 
                                type: 'category',
                                data: charts_data.crop_advantages_radar.xAxis,
                                axisLabel: { 
                                    rotate: 45,
                                    fontSize: 10
                                }
                            },
                            yAxis: { 
                                type: 'value', 
                                name: 'æ¸©åº¦(Â°C)',
                                nameTextStyle: { fontSize: 12 }
                            },
                            series: charts_data.crop_advantages_radar.series.map(s => ({
                                ...s,
                                itemStyle: {
                                    color: s.name === 'æœ€ä½æ¸©åº¦' ? '#4ECDC4' : '#FF6B6B'
                                }
                            }))
                        });
                        console.log('âœ… ä½œç‰©æ¸©åº¦éœ€æ±‚å›¾è®¾ç½®å®Œæˆ');
                    }
                    
                    // pHéœ€æ±‚åˆ†å¸ƒé¥¼å›¾
                    if (charts_data.limiting_factors_pie && charts_data.limiting_factors_pie.data) {
                        console.log('ğŸ¥§ è®¾ç½®pHéœ€æ±‚é¥¼å›¾ï¼Œæ•°æ®ç‚¹:', charts_data.limiting_factors_pie.data.length);
                        charts.limitingFactorsChart.setOption({
                            title: { 
                                text: charts_data.limiting_factors_pie.title || 'ä½œç‰©pHéœ€æ±‚åˆ†å¸ƒ',
                                left: 'center',
                                textStyle: { fontSize: 16, fontWeight: 'bold' }
                            },
                            tooltip: { 
                                trigger: 'item',
                                formatter: '{a} <br/>{b}: {c}ç§ä½œç‰© ({d}%)'
                            },
                            legend: { 
                                orient: 'vertical', 
                                left: 'left',
                                top: 'middle'
                            },
                            series: [{
                                name: 'pHéœ€æ±‚',
                                type: 'pie',
                                radius: ['30%', '70%'],
                                center: ['60%', '50%'],
                                data: charts_data.limiting_factors_pie.data,
                                emphasis: { 
                                    itemStyle: { 
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                },
                                label: {
                                    show: true,
                                    formatter: '{b}\n{c}ç§'
                                }
                            }]
                        });
                        console.log('âœ… pHéœ€æ±‚é¥¼å›¾è®¾ç½®å®Œæˆ');
                    }
                    
                    console.log('âœ… ä½œç‰©å›¾è¡¨åŠ è½½å®Œæˆ');
                } else {
                    console.error('ä½œç‰©åˆ†æAPIè¿”å›é”™è¯¯:', result.message);
                }
            } catch (error) {
                console.error('åŠ è½½ä½œç‰©å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½åŒºåˆ’å›¾è¡¨
        async function loadZoningCharts() {
            try {
                console.log('ğŸ—ºï¸ å¼€å§‹åŠ è½½åŒºåˆ’å›¾è¡¨...');
                const response = await fetch('/api/echarts/zoning_optimization');
                const result = await response.json();
                
                console.log('ğŸ“Š åŒºåˆ’åˆ†æAPIå“åº”:', result);
                
                if (result.status === 'success') {
                    const charts_data = result.charts;
                    console.log('ğŸ“ˆ åŒºåˆ’å›¾è¡¨æ•°æ®:', Object.keys(charts_data));
                    
                    // åŒºåˆ’æ•£ç‚¹å›¾ï¼ˆå¿å¸‚åœŸå£¤è´¨é‡åˆ†å¸ƒï¼‰
                    if (charts_data.zoning_scatter && charts_data.zoning_scatter.series) {
                        console.log('ğŸ“Š è®¾ç½®åŒºåˆ’æ•£ç‚¹å›¾');
                        charts.zoningScatterChart.setOption({
                            title: { 
                                text: charts_data.zoning_scatter.title || 'æ¹–å—çœå¿å¸‚åœŸå£¤è´¨é‡åˆ†å¸ƒ',
                                left: 'center',
                                textStyle: { fontSize: 16, fontWeight: 'bold' }
                            },
                            tooltip: { 
                                trigger: 'item',
                                formatter: function(params) {
                                    return `${params.data[2]}<br/>pHå€¼: ${params.data[0]}<br/>è´¨é‡è¯„åˆ†: ${params.data[1]}<br/>æ ·æœ¬æ•°: ${params.data[3]}`;
                                }
                            },
                            xAxis: { 
                                type: 'value', 
                                name: 'pHå€¼',
                                nameLocation: 'middle',
                                nameGap: 30
                            },
                            yAxis: { 
                                type: 'value', 
                                name: 'åœŸå£¤è´¨é‡è¯„åˆ†',
                                nameLocation: 'middle',
                                nameGap: 50
                            },
                            series: charts_data.zoning_scatter.series.map(s => ({
                                ...s,
                                itemStyle: {
                                    color: '#4ECDC4',
                                    borderColor: '#333',
                                    borderWidth: 1
                                },
                                emphasis: {
                                    itemStyle: {
                                        color: '#FF6B6B'
                                    }
                                }
                            }))
                        });
                        console.log('âœ… åŒºåˆ’æ•£ç‚¹å›¾è®¾ç½®å®Œæˆ');
                    }
                    
                    // ä¼˜åŒ–å»ºè®®å›¾è¡¨ï¼ˆç®€åŒ–ä¸ºæŸ±çŠ¶å›¾ï¼Œé¿å…åœ°å›¾ç»„ä»¶é—®é¢˜ï¼‰
                    if (charts_data.optimization_map && charts_data.optimization_map.series) {
                        console.log('ğŸ“Š è®¾ç½®ä¼˜åŒ–å»ºè®®å›¾è¡¨');
                        
                        // æå–åœ°ç†æ•°æ®è½¬æ¢ä¸ºæŸ±çŠ¶å›¾
                        const mapData = charts_data.optimization_map.series[0].data || [];
                        const cityNames = mapData.map(item => item[2] || 'æœªçŸ¥åŸå¸‚');
                        const cityValues = mapData.map((item, index) => index + 1); // ç®€å•çš„æ’åºå€¼
                        
                        charts.optimizationMapChart.setOption({
                            title: { 
                                text: 'æ¹–å—çœä¼˜åŒ–å»ºè®®åŒºåŸŸ',
                                left: 'center',
                                textStyle: { fontSize: 16, fontWeight: 'bold' }
                            },
                            tooltip: { 
                                trigger: 'axis',
                                axisPointer: { type: 'shadow' }
                            },
                            xAxis: { 
                                type: 'category',
                                data: cityNames,
                                axisLabel: { 
                                    rotate: 45,
                                    fontSize: 12
                                }
                            },
                            yAxis: { 
                                type: 'value', 
                                name: 'ä¼˜åŒ–ä¼˜å…ˆçº§',
                                nameLocation: 'middle',
                                nameGap: 50
                            },
                            series: [{
                                name: 'ä¼˜åŒ–å»ºè®®',
                                type: 'bar',
                                data: cityValues,
                                itemStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        {offset: 0, color: '#83bff6'},
                                        {offset: 0.5, color: '#188df0'},
                                        {offset: 1, color: '#188df0'}
                                    ])
                                },
                                emphasis: {
                                    itemStyle: {
                                        color: '#FF6B6B'
                                    }
                                }
                            }]
                        });
                        console.log('âœ… ä¼˜åŒ–å»ºè®®å›¾è¡¨è®¾ç½®å®Œæˆ');
                    }
                    
                    console.log('âœ… åŒºåˆ’å›¾è¡¨åŠ è½½å®Œæˆ');
                } else {
                    console.error('åŒºåˆ’åˆ†æAPIè¿”å›é”™è¯¯:', result.message);
                }
            } catch (error) {
                console.error('åŠ è½½åŒºåˆ’å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // æ£€æŸ¥EChartsæ˜¯å¦åŠ è½½
            if (typeof echarts === 'undefined') {
                console.error('âŒ EChartsåº“æœªåŠ è½½ï¼');
                alert('EChartsåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            } else {
                console.log('âœ… EChartsåº“å·²åŠ è½½ï¼Œç‰ˆæœ¬:', echarts.version);
            }
            
            // åˆå§‹åŒ–å›¾è¡¨
            try {
                initCharts();
                console.log('âœ… å›¾è¡¨å®¹å™¨åˆå§‹åŒ–å®Œæˆ');
                
                // éªŒè¯å›¾è¡¨å®¹å™¨
                const chartCount = Object.keys(charts).length;
                console.log(`ğŸ“Š å·²åˆå§‹åŒ– ${chartCount} ä¸ªå›¾è¡¨å®¹å™¨`);
                
                // æµ‹è¯•ä¸€ä¸ªç®€å•å›¾è¡¨
                if (charts.tempTrendChart) {
                    charts.tempTrendChart.setOption({
                        title: { text: 'ç­‰å¾…æ•°æ®...' },
                        xAxis: { data: [] },
                        yAxis: {},
                        series: []
                    });
                    console.log('âœ… æµ‹è¯•å›¾è¡¨è®¾ç½®æˆåŠŸ');
                }
                
            } catch (error) {
                console.error('âŒ å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('initSystemBtn').addEventListener('click', initializeSystem);
            document.getElementById('runAnalysisBtn').addEventListener('click', runAnalysis);
            
            // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            checkSystemStatus();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„åˆ†æ
            setTimeout(async () => {
                const analysisCompleted = await checkAnalysisStatus();
                if (analysisCompleted) {
                    console.log('ğŸ‰ æ£€æµ‹åˆ°ä¹‹å‰çš„åˆ†æå·²å®Œæˆï¼Œå›¾è¡¨å·²åŠ è½½');
                }
            }, 2000);
            
            console.log('ğŸ‰ é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const result = await response.json();
                
                if (result.spark_initialized) {
                    systemInitialized = true;
                    updateSystemStatus('ready', 'ç³»ç»Ÿå°±ç»ª');
                    document.getElementById('runAnalysisBtn').disabled = false;
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            }
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', function() {
            Object.values(charts).forEach(chart => {
                if (chart) chart.resize();
            });
        });
    </script>
</body>
</html>
