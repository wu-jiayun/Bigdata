<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EChartsè¯¦ç»†è¯Šæ–­</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .chart-container { width: 400px; height: 300px; border: 1px solid #999; margin: 10px 0; }
        .log { background: #f5f5f5; padding: 10px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>EChartsè¯¦ç»†è¯Šæ–­æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. åŸºç¡€EChartsæµ‹è¯•</h2>
        <div id="basicChart" class="chart-container"></div>
        <button onclick="testBasicECharts()">æµ‹è¯•åŸºç¡€ECharts</button>
    </div>
    
    <div class="test-section">
        <h2>2. DOMå…ƒç´ æ£€æŸ¥</h2>
        <button onclick="checkDOMElements()">æ£€æŸ¥æ‰€æœ‰å›¾è¡¨å®¹å™¨</button>
    </div>
    
    <div class="test-section">
        <h2>3. æ¨¡å—åŠ è½½æµ‹è¯•</h2>
        <button onclick="testModuleLoading()">æµ‹è¯•æ¨¡å—åŠ è½½</button>
    </div>
    
    <div class="test-section">
        <h2>4. APIæ•°æ®æµ‹è¯•</h2>
        <button onclick="testAPIData()">æµ‹è¯•APIæ•°æ®</button>
    </div>
    
    <div class="test-section">
        <h2>5. å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <button onclick="testFullWorkflow()">æµ‹è¯•å®Œæ•´å·¥ä½œæµç¨‹</button>
    </div>
    
    <div class="test-section">
        <h2>è¯Šæ–­æ—¥å¿—</h2>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function testBasicECharts() {
            log('=== å¼€å§‹åŸºç¡€EChartsæµ‹è¯• ===');
            
            try {
                // æ£€æŸ¥EChartsæ˜¯å¦åŠ è½½
                if (typeof echarts === 'undefined') {
                    log('âŒ EChartsåº“æœªåŠ è½½', 'error');
                    return;
                }
                log('âœ… EChartsåº“å·²åŠ è½½ï¼Œç‰ˆæœ¬: ' + echarts.version, 'success');
                
                // è·å–å®¹å™¨
                const container = document.getElementById('basicChart');
                if (!container) {
                    log('âŒ æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨', 'error');
                    return;
                }
                log('âœ… å›¾è¡¨å®¹å™¨å­˜åœ¨', 'success');
                
                // åˆå§‹åŒ–å›¾è¡¨
                const chart = echarts.init(container);
                if (!chart) {
                    log('âŒ EChartså®ä¾‹åˆå§‹åŒ–å¤±è´¥', 'error');
                    return;
                }
                log('âœ… EChartså®ä¾‹åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // è®¾ç½®é€‰é¡¹
                const option = {
                    title: { text: 'åŸºç¡€æµ‹è¯•å›¾è¡¨' },
                    tooltip: {},
                    xAxis: { data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'] },
                    yAxis: {},
                    series: [{
                        name: 'æµ‹è¯•æ•°æ®',
                        type: 'bar',
                        data: [10, 20, 30, 40, 50]
                    }]
                };
                
                chart.setOption(option);
                log('âœ… åŸºç¡€å›¾è¡¨æ¸²æŸ“æˆåŠŸ', 'success');
                
            } catch (error) {
                log('âŒ åŸºç¡€EChartsæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function checkDOMElements() {
            log('=== å¼€å§‹DOMå…ƒç´ æ£€æŸ¥ ===');
            
            const chartIds = [
                'tempTrendChart', 'precipPatternChart', 'climateHeatmapChart',
                'soilTypePieChart', 'phDistChart', 'countyQualityChart',
                'suitabilityDistChart', 'cropRadarChart', 'limitingFactorsChart',
                'zoningScatterChart', 'optimizationMapChart'
            ];
            
            let foundCount = 0;
            chartIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    foundCount++;
                    log(`âœ… æ‰¾åˆ°å®¹å™¨: ${id}`, 'success');
                } else {
                    log(`âŒ ç¼ºå¤±å®¹å™¨: ${id}`, 'error');
                }
            });
            
            log(`ğŸ“Š å®¹å™¨æ£€æŸ¥å®Œæˆ: ${foundCount}/${chartIds.length} ä¸ªå®¹å™¨å­˜åœ¨`);
        }
        
        async function testModuleLoading() {
            log('=== å¼€å§‹æ¨¡å—åŠ è½½æµ‹è¯• ===');
            
            try {
                // æ£€æŸ¥å…¨å±€å¯¹è±¡
                log('æ£€æŸ¥å…¨å±€æ¨¡å—å¯¹è±¡:');
                log('- window.SparkCore: ' + (!!window.SparkCore));
                log('- window.SystemControl: ' + (!!window.SystemControl));
                log('- window.ChartLoader: ' + (!!window.ChartLoader));
                
                if (window.SparkCore && window.SparkCore.charts) {
                    const charts = window.SparkCore.charts;
                    const chartCount = Object.keys(charts).length;
                    log(`âœ… SparkCore.charts å­˜åœ¨ï¼ŒåŒ…å« ${chartCount} ä¸ªå›¾è¡¨å®ä¾‹`, 'success');
                    
                    // æ£€æŸ¥æ¯ä¸ªå›¾è¡¨å®ä¾‹
                    Object.keys(charts).forEach(key => {
                        if (charts[key]) {
                            log(`  âœ… ${key}: å·²åˆå§‹åŒ–`, 'success');
                        } else {
                            log(`  âŒ ${key}: æœªåˆå§‹åŒ–`, 'error');
                        }
                    });
                } else {
                    log('âŒ SparkCore.charts ä¸å­˜åœ¨', 'error');
                }
                
            } catch (error) {
                log('âŒ æ¨¡å—åŠ è½½æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function testAPIData() {
            log('=== å¼€å§‹APIæ•°æ®æµ‹è¯• ===');
            
            try {
                // æµ‹è¯•ç³»ç»Ÿåˆå§‹åŒ–
                log('1. æµ‹è¯•ç³»ç»Ÿåˆå§‹åŒ–...');
                const initResp = await fetch('/api/system/initialize', { method: 'POST' });
                const initResult = await initResp.json();
                
                if (initResult.status === 'success') {
                    log('âœ… ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ', 'success');
                    log('æ•°æ®æ‘˜è¦: ' + JSON.stringify(initResult.data_summary));
                } else {
                    log('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + initResult.message, 'error');
                    return;
                }
                
                // æµ‹è¯•åˆ†æè¿è¡Œ
                log('2. æµ‹è¯•åˆ†æè¿è¡Œ...');
                const analysisResp = await fetch('/api/analysis/run', { method: 'POST' });
                const analysisResult = await analysisResp.json();
                
                if (analysisResult.status === 'success') {
                    log('âœ… åˆ†æè¿è¡ŒæˆåŠŸ', 'success');
                } else {
                    log('âŒ åˆ†æè¿è¡Œå¤±è´¥: ' + analysisResult.message, 'error');
                    return;
                }
                
                // æµ‹è¯•å„ä¸ªå›¾è¡¨API
                const apis = [
                    '/api/echarts/climate_trends',
                    '/api/echarts/soil_analysis',
                    '/api/echarts/crop_suitability',
                    '/api/echarts/zoning_optimization'
                ];
                
                log('3. æµ‹è¯•å›¾è¡¨API...');
                for (const api of apis) {
                    try {
                        const resp = await fetch(api);
                        const result = await resp.json();
                        
                        if (result.status === 'success') {
                            const chartCount = Object.keys(result.charts).length;
                            log(`âœ… ${api}: æˆåŠŸ (${chartCount}ä¸ªå›¾è¡¨)`, 'success');
                        } else {
                            log(`âŒ ${api}: å¤±è´¥ - ${result.message}`, 'error');
                        }
                    } catch (error) {
                        log(`âŒ ${api}: è¯·æ±‚å¼‚å¸¸ - ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log('âŒ APIæ•°æ®æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function testFullWorkflow() {
            log('=== å¼€å§‹å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯• ===');
            
            try {
                // 1. æ£€æŸ¥åŸºç¡€ç¯å¢ƒ
                log('1. æ£€æŸ¥åŸºç¡€ç¯å¢ƒ...');
                if (typeof echarts === 'undefined') {
                    log('âŒ EChartsæœªåŠ è½½', 'error');
                    return;
                }
                
                // 2. æ£€æŸ¥DOMå®¹å™¨
                log('2. æ£€æŸ¥DOMå®¹å™¨...');
                const tempChart = document.getElementById('tempTrendChart');
                if (!tempChart) {
                    log('âŒ ä¸»é¡µé¢å›¾è¡¨å®¹å™¨ä¸å­˜åœ¨ï¼Œå¯èƒ½ä¸åœ¨æ­£ç¡®é¡µé¢', 'warning');
                    return;
                }
                
                // 3. åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
                log('3. å°è¯•åˆå§‹åŒ–å›¾è¡¨å®ä¾‹...');
                const chart = echarts.init(tempChart);
                if (!chart) {
                    log('âŒ å›¾è¡¨å®ä¾‹åˆå§‹åŒ–å¤±è´¥', 'error');
                    return;
                }
                log('âœ… å›¾è¡¨å®ä¾‹åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // 4. æµ‹è¯•ç®€å•æ•°æ®æ¸²æŸ“
                log('4. æµ‹è¯•ç®€å•æ•°æ®æ¸²æŸ“...');
                const option = {
                    title: { text: 'æµ‹è¯•å›¾è¡¨' },
                    xAxis: { data: ['A', 'B', 'C'] },
                    yAxis: {},
                    series: [{ type: 'bar', data: [1, 2, 3] }]
                };
                
                chart.setOption(option);
                log('âœ… ç®€å•æ•°æ®æ¸²æŸ“æˆåŠŸ', 'success');
                
                // 5. æµ‹è¯•APIæ•°æ®æ¸²æŸ“
                log('5. æµ‹è¯•APIæ•°æ®æ¸²æŸ“...');
                await testAPIData();
                
            } catch (error) {
                log('âŒ å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.onload = function() {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨è¯Šæ–­...', 'success');
            setTimeout(() => {
                testBasicECharts();
                checkDOMElements();
                testModuleLoading();
            }, 1000);
        };
    </script>
</body>
</html>
