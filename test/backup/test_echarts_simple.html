<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECharts简单测试</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <h1>ECharts图表加载测试</h1>
    
    <div id="testChart" style="width: 600px; height: 400px; border: 1px solid #ccc; margin: 20px;"></div>
    
    <button onclick="testBasicChart()">测试基础图表</button>
    <button onclick="testAPIData()">测试API数据</button>
    
    <div id="log" style="margin: 20px; padding: 10px; background: #f5f5f5; font-family: monospace; white-space: pre-wrap;"></div>
    
    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }
        
        function testBasicChart() {
            log('开始测试基础图表...');
            
            const chart = echarts.init(document.getElementById('testChart'));
            
            const option = {
                title: { text: '基础测试图表' },
                tooltip: {},
                xAxis: { data: ['A', 'B', 'C', 'D', 'E'] },
                yAxis: {},
                series: [{
                    name: '测试数据',
                    type: 'bar',
                    data: [10, 20, 30, 40, 50]
                }]
            };
            
            chart.setOption(option);
            log('✅ 基础图表设置成功');
        }
        
        async function testAPIData() {
            log('开始测试API数据...');
            
            try {
                // 先初始化系统
                log('1. 初始化系统...');
                const initResp = await fetch('/api/system/initialize', { method: 'POST' });
                const initResult = await initResp.json();
                log('初始化结果: ' + initResult.status);
                
                if (initResult.status === 'success') {
                    // 运行分析
                    log('2. 运行分析...');
                    const analysisResp = await fetch('/api/analysis/run', { method: 'POST' });
                    const analysisResult = await analysisResp.json();
                    log('分析结果: ' + analysisResult.status);
                    
                    if (analysisResult.status === 'success') {
                        // 测试气候数据
                        log('3. 获取气候数据...');
                        const climateResp = await fetch('/api/echarts/climate_trends');
                        const climateResult = await climateResp.json();
                        log('气候API状态: ' + climateResult.status);
                        
                        if (climateResult.status === 'success') {
                            const charts = climateResult.charts;
                            log('可用图表: ' + Object.keys(charts).join(', '));
                            
                            // 尝试渲染第一个图表
                            const firstChart = Object.values(charts)[0];
                            if (firstChart && firstChart.xAxis && firstChart.series) {
                                log('4. 渲染图表...');
                                const chart = echarts.init(document.getElementById('testChart'));
                                
                                const option = {
                                    title: { text: firstChart.title || '气候数据图表' },
                                    tooltip: { trigger: 'axis' },
                                    xAxis: { 
                                        type: 'category',
                                        data: firstChart.xAxis 
                                    },
                                    yAxis: { type: 'value' },
                                    series: firstChart.series
                                };
                                
                                chart.setOption(option);
                                log('✅ API数据图表渲染成功');
                            } else {
                                log('❌ 图表数据结构不正确');
                                log('数据结构: ' + JSON.stringify(firstChart, null, 2));
                            }
                        } else {
                            log('❌ 气候API失败: ' + climateResult.message);
                        }
                    } else {
                        log('❌ 分析失败: ' + analysisResult.message);
                    }
                } else {
                    log('❌ 初始化失败: ' + initResult.message);
                }
            } catch (error) {
                log('❌ 测试失败: ' + error.message);
            }
        }
        
        // 页面加载完成后自动测试基础图表
        window.onload = function() {
            log('页面加载完成');
            testBasicChart();
        };
    </script>
</body>
</html>
