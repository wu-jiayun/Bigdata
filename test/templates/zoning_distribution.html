<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šå‡†åˆ™é€‚å®œæ€§åŒºåˆ’ - æ¹–å—çœå†œä¸šåˆ†æç³»ç»Ÿ</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
        }
        .btn-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .zone-card {
            border-left: 5px solid;
            margin: 10px 0;
            padding: 15px;
        }
        .zone-optimal { border-left-color: #4CAF50; background: #f1f8e9; }
        .zone-suitable { border-left-color: #2196F3; background: #e3f2fd; }
        .zone-marginal { border-left-color: #FF9800; background: #fff3e0; }
        .zone-unsuitable { border-left-color: #F44336; background: #ffebee; }
        .distribution-map {
            width: 100%;
            height: 600px;
            min-height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 4px;
        }
        .statistics-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .btn-generate {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            color: white;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">ğŸ—ºï¸ å¤šå‡†åˆ™é€‚å®œæ€§åŒºåˆ’</span>
            <a href="/" class="btn btn-back">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- åŒºåˆ’ç”Ÿæˆæ§åˆ¶ -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">ğŸ¯ åŒºåˆ’ç”Ÿæˆæ§åˆ¶</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">é€‰æ‹©ä½œç‰©ç±»å‹</label>
                        <select class="form-select" id="cropType">
                            <option value="rice">ğŸš æ°´ç¨»</option>
                            <option value="corn">ğŸŒ½ ç‰ç±³</option>
                            <option value="soybean">ğŸ«˜ å¤§è±†</option>
                            <option value="wheat">ğŸŒ¾ å°éº¦</option>
                            <option value="cotton">ğŸŒ¸ æ£‰èŠ±</option>
                            <option value="rapeseed">ğŸŒ» æ²¹èœ</option>
                            <option value="peanut">ğŸ¥œ èŠ±ç”Ÿ</option>
                            <option value="sweet_potato">ğŸ  çº¢è–¯</option>
                            <option value="tobacco">ğŸš¬ çƒŸè‰</option>
                            <option value="tea">ğŸµ èŒ¶å¶</option>
                            <option value="citrus">ğŸŠ æŸ‘æ©˜</option>
                            <option value="vegetables">ğŸ¥¬ è”¬èœ</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">åŒºåˆ’ç²¾åº¦</label>
                        <select class="form-select" id="precisionSelect">
                            <option value="county">å¿çº§ç²¾åº¦</option>
                            <option value="township">ä¹¡é•‡çº§ç²¾åº¦</option>
                            <option value="village">æ‘çº§ç²¾åº¦</option>
                        </select>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-generate btn-lg" onclick="generateZoning()">ğŸ—ºï¸ ç”Ÿæˆé€‚å®œæ€§åŒºåˆ’å›¾</button>
                </div>
            </div>
        </div>

        <!-- ç©ºé—´åˆ†å¸ƒå›¾ -->
        <div class="card" id="mapCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">ğŸŒ ç©ºé—´åˆ†å¸ƒå›¾</h5>
            </div>
            <div class="card-body">
                <div id="distributionMap" class="distribution-map"></div>
            </div>
        </div>

        <!-- åŒºåˆ’ç»Ÿè®¡ -->
        <div class="card" id="statisticsCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">ğŸ“Š åŒºåˆ’ç»Ÿè®¡åˆ†æ</h5>
            </div>
            <div class="card-body">
                <div class="row" id="statisticsContent">
                    <!-- ç»Ÿè®¡å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- é€‚å®œæ€§åˆ†åŒºè¯¦æƒ… -->
        <div class="card" id="zonesCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">ğŸ“‹ é€‚å®œæ€§åˆ†åŒºè¯¦æƒ…</h5>
            </div>
            <div class="card-body">
                <!-- æœ€é€‚å®œåŒº -->
                <div class="zone-card zone-optimal">
                    <h6>ğŸŸ¢ æœ€é€‚å®œåŒº</h6>
                    <div id="optimalZoneContent">
                        <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <!-- é€‚å®œåŒº -->
                <div class="zone-card zone-suitable">
                    <h6>ğŸ”µ é€‚å®œåŒº</h6>
                    <div id="suitableZoneContent">
                        <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <!-- è¾ƒé€‚å®œåŒº -->
                <div class="zone-card zone-marginal">
                    <h6>ğŸŸ¡ è¾ƒé€‚å®œåŒº</h6>
                    <div id="marginalZoneContent">
                        <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <!-- ä¸é€‚å®œåŒº -->
                <div class="zone-card zone-unsuitable">
                    <h6>ğŸ”´ ä¸é€‚å®œåŒº</h6>
                    <div id="unsuitableZoneContent">
                        <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å›¾ä¾‹è¯´æ˜ -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">ğŸ“– å›¾ä¾‹è¯´æ˜</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>ğŸ¨ é€‚å®œæ€§ç­‰çº§é¢œè‰²</h6>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4CAF50;"></div>
                            <span>æœ€é€‚å®œåŒº (è¯„åˆ† â‰¥ 80)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2196F3;"></div>
                            <span>é€‚å®œåŒº (è¯„åˆ† 60-79)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #FF9800;"></div>
                            <span>è¾ƒé€‚å®œåŒº (è¯„åˆ† 40-59)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #F44336;"></div>
                            <span>ä¸é€‚å®œåŒº (è¯„åˆ† < 40)</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>ğŸ“ ç²¾åº¦è¯´æ˜</h6>
                        <ul class="list-unstyled">
                            <li>â€¢ <strong>å¿çº§ç²¾åº¦</strong>: ä»¥å¿ä¸ºå•ä½è¿›è¡ŒåŒºåˆ’</li>
                            <li>â€¢ <strong>ä¹¡é•‡çº§ç²¾åº¦</strong>: ä»¥ä¹¡é•‡ä¸ºå•ä½è¿›è¡ŒåŒºåˆ’</li>
                            <li>â€¢ <strong>æ‘çº§ç²¾åº¦</strong>: ä»¥æ‘ä¸ºå•ä½è¿›è¡ŒåŒºåˆ’</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('ğŸ—ºï¸ å¤šå‡†åˆ™é€‚å®œæ€§åŒºåˆ’é¡µé¢å¯åŠ¨');

        let distributionChart = null;

        // ç”Ÿæˆé€‚å®œæ€§åŒºåˆ’
        async function generateZoning() {
            console.log('ğŸ¯ å¼€å§‹ç”Ÿæˆé€‚å®œæ€§åŒºåˆ’');
            
            const cropType = document.getElementById('cropType').value;
            const precision = document.getElementById('precisionSelect').value;
            
            try {
                const response = await fetch('/api/zoning/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        crop_type: cropType,
                        precision: precision
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    displayZoningResults(result.zoning);
                    console.log('âœ… é€‚å®œæ€§åŒºåˆ’ç”ŸæˆæˆåŠŸ');
                } else {
                    alert('åŒºåˆ’ç”Ÿæˆå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('âŒ åŒºåˆ’ç”Ÿæˆè¯·æ±‚å¼‚å¸¸:', error);
                // æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
                displayMockZoningResults(cropType, precision);
                
                // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è°ƒæ•´åœ°å›¾
                window.addEventListener('resize', function() {
                    if (distributionChart) {
                        distributionChart.resize();
                    }
                });
            }
        }

        // æ˜¾ç¤ºåŒºåˆ’ç»“æœ
        function displayZoningResults(zoning) {
            // æ˜¾ç¤ºç©ºé—´åˆ†å¸ƒå›¾
            displayDistributionMap(zoning.spatial_data);
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            displayStatistics(zoning.statistics);
            
            // æ˜¾ç¤ºåˆ†åŒºè¯¦æƒ…
            displayZoneDetails(zoning.zones);
            
            // æ˜¾ç¤ºæ‰€æœ‰ç»“æœå¡ç‰‡
            document.getElementById('mapCard').style.display = 'block';
            document.getElementById('statisticsCard').style.display = 'block';
            document.getElementById('zonesCard').style.display = 'block';
        }

        // æ˜¾ç¤ºç©ºé—´åˆ†å¸ƒå›¾
        function displayDistributionMap(spatialData) {
            if (!distributionChart) {
                distributionChart = echarts.init(document.getElementById('distributionMap'));
            }

            const option = {
                title: {
                    text: 'ä½œç‰©ç§æ¤é€‚å®œæ€§ç©ºé—´åˆ†å¸ƒ',
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return `
                            <div style="padding: 8px;">
                                <strong>${params.data.name}</strong><br/>
                                é€‚å®œæ€§è¯„åˆ†: ${params.data.score}<br/>
                                ç­‰çº§: ${params.data.level}
                            </div>
                        `;
                    }
                },
                visualMap: {
                    min: 0,
                    max: 100,
                    text: ['é«˜', 'ä½'],
                    realtime: false,
                    calculable: true,
                    inRange: {
                        color: ['#F44336', '#FF9800', '#2196F3', '#4CAF50']
                    },
                    left: 'left',
                    top: 'bottom'
                },
                geo: {
                    map: 'hunan',
                    roam: true,
                    center: [112.5, 28.2],
                    zoom: 1.2,
                    scaleLimit: {
                        min: 0.8,
                        max: 3
                    },
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 2,
                        areaColor: '#f0f0f0'
                    },
                    emphasis: {
                        itemStyle: {
                            areaColor: '#389BB7',
                            borderWidth: 3
                        }
                    },
                    layoutCenter: ['50%', '50%'],
                    layoutSize: '80%'
                },
                series: [{
                    name: 'é€‚å®œæ€§è¯„åˆ†',
                    type: 'map',
                    geoIndex: 0,
                    data: spatialData.map(item => ({
                        name: item.name,
                        value: item.score,
                        level: item.level
                    })),
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 1
                    },
                    emphasis: {
                        itemStyle: {
                            borderWidth: 2
                        }
                    }
                }]
            };

            // æ³¨å†Œæ¹–å—çœåœ°å›¾
            fetch('/static/hunan.json')
                .then(response => response.json())
                .then(hunanGeoJson => {
                    echarts.registerMap('hunan', hunanGeoJson);
                    distributionChart.setOption(option);
                    
                    // ç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“
                    setTimeout(() => {
                        distributionChart.resize();
                    }, 100);
                })
                .catch(error => {
                    console.error('âŒ æ¹–å—çœåœ°å›¾æ•°æ®åŠ è½½å¤±è´¥:', error);
                    // ä½¿ç”¨é»˜è®¤ä¸­å›½åœ°å›¾å¹¶èšç„¦æ¹–å—
                    option.geo.map = 'china';
                    option.geo.center = [112.5, 28.2];
                    option.geo.zoom = 6;
                    option.geo.layoutSize = '60%';
                    distributionChart.setOption(option);
                    
                    // ç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“
                    setTimeout(() => {
                        distributionChart.resize();
                    }, 100);
                });
        }

        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        function displayStatistics(statistics) {
            const statsContent = document.getElementById('statisticsContent');
            
            const stats = statistics || {
                optimal: { count: 15, percentage: 25, area: 3250 },
                suitable: { count: 28, percentage: 35, area: 4800 },
                marginal: { count: 22, percentage: 25, area: 3100 },
                unsuitable: { count: 12, percentage: 15, area: 1850 }
            };

            statsContent.innerHTML = `
                <div class="col-md-3">
                    <div class="statistics-card" style="background: #e8f5e8;">
                        <h3 style="color: #4CAF50;">${stats.optimal.count}</h3>
                        <p>æœ€é€‚å®œåŒºå¿æ•°</p>
                        <small>${stats.optimal.percentage}% | ${stats.optimal.area}kmÂ²</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="statistics-card" style="background: #e3f2fd;">
                        <h3 style="color: #2196F3;">${stats.suitable.count}</h3>
                        <p>é€‚å®œåŒºå¿æ•°</p>
                        <small>${stats.suitable.percentage}% | ${stats.suitable.area}kmÂ²</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="statistics-card" style="background: #fff3e0;">
                        <h3 style="color: #FF9800;">${stats.marginal.count}</h3>
                        <p>è¾ƒé€‚å®œåŒºå¿æ•°</p>
                        <small>${stats.marginal.percentage}% | ${stats.marginal.area}kmÂ²</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="statistics-card" style="background: #ffebee;">
                        <h3 style="color: #F44336;">${stats.unsuitable.count}</h3>
                        <p>ä¸é€‚å®œåŒºå¿æ•°</p>
                        <small>${stats.unsuitable.percentage}% | ${stats.unsuitable.area}kmÂ²</small>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºåˆ†åŒºè¯¦æƒ…
        function displayZoneDetails(zones) {
            const mockZones = zones || {
                optimal: ['é•¿æ²™å¿', 'æµé˜³å¸‚', 'å®ä¹¡å¸‚', 'æœ›åŸåŒº', 'å²³éº“åŒº'],
                suitable: ['æ ªæ´²å¿', 'æ¹˜æ½­å¿', 'è¡¡é˜³å¿', 'é‚µé˜³å¿', 'å²³é˜³å¿'],
                marginal: ['å¸¸å¾·å¸‚', 'å¼ å®¶ç•Œå¸‚', 'ç›Šé˜³å¸‚', 'éƒ´å·å¸‚', 'æ°¸å·å¸‚'],
                unsuitable: ['æ¹˜è¥¿å·', 'æ€€åŒ–å¸‚', 'å¨„åº•å¸‚']
            };

            document.getElementById('optimalZoneContent').innerHTML = `
                <p><strong>åŒºåŸŸç‰¹ç‚¹</strong>: æ°”å€™æ¡ä»¶ä¼˜è¶Šï¼ŒåœŸå£¤è‚¥æ²ƒï¼Œæ°´èµ„æºå……è¶³</p>
                <p><strong>åŒ…å«åŒºåŸŸ</strong>: ${mockZones.optimal.join('ã€')}</p>
                <p><strong>ç§æ¤å»ºè®®</strong>: å¯å¤§è§„æ¨¡ç§æ¤ï¼Œé¢„æœŸäº§é‡é«˜ï¼Œç»æµæ•ˆç›Šå¥½</p>
            `;

            document.getElementById('suitableZoneContent').innerHTML = `
                <p><strong>åŒºåŸŸç‰¹ç‚¹</strong>: åŸºæœ¬æ¡ä»¶è‰¯å¥½ï¼Œéƒ¨åˆ†å› å­éœ€è¦æ”¹å–„</p>
                <p><strong>åŒ…å«åŒºåŸŸ</strong>: ${mockZones.suitable.join('ã€')}</p>
                <p><strong>ç§æ¤å»ºè®®</strong>: é€‚åˆç§æ¤ï¼Œéœ€è¦é€‚å½“çš„æŠ€æœ¯æªæ–½å’Œç®¡ç†</p>
            `;

            document.getElementById('marginalZoneContent').innerHTML = `
                <p><strong>åŒºåŸŸç‰¹ç‚¹</strong>: æ¡ä»¶ä¸€èˆ¬ï¼Œå­˜åœ¨é™åˆ¶å› å­</p>
                <p><strong>åŒ…å«åŒºåŸŸ</strong>: ${mockZones.marginal.join('ã€')}</p>
                <p><strong>ç§æ¤å»ºè®®</strong>: éœ€è¦é‡ç‚¹æ”¹è‰¯åœŸå£¤æˆ–é€‰æ‹©é€‚åº”æ€§å“ç§</p>
            `;

            document.getElementById('unsuitableZoneContent').innerHTML = `
                <p><strong>åŒºåŸŸç‰¹ç‚¹</strong>: è‡ªç„¶æ¡ä»¶ä¸é€‚å®œï¼Œé™åˆ¶å› å­è¾ƒå¤š</p>
                <p><strong>åŒ…å«åŒºåŸŸ</strong>: ${mockZones.unsuitable.join('ã€')}</p>
                <p><strong>ç§æ¤å»ºè®®</strong>: ä¸å»ºè®®ç§æ¤è¯¥ä½œç‰©ï¼Œå¯è€ƒè™‘å…¶ä»–æ›¿ä»£ä½œç‰©</p>
            `;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿç©ºé—´æ•°æ®
        function generateMockSpatialData() {
            const counties = [
                'é•¿æ²™å¸‚', 'æ ªæ´²å¸‚', 'æ¹˜æ½­å¸‚', 'è¡¡é˜³å¸‚', 'é‚µé˜³å¸‚', 'å²³é˜³å¸‚', 
                'å¸¸å¾·å¸‚', 'å¼ å®¶ç•Œå¸‚', 'ç›Šé˜³å¸‚', 'éƒ´å·å¸‚', 'æ°¸å·å¸‚', 'æ€€åŒ–å¸‚', 
                'å¨„åº•å¸‚', 'æ¹˜è¥¿å·'
            ];

            return counties.map(county => ({
                name: county,
                value: Math.floor(Math.random() * 100),
                score: Math.floor(Math.random() * 100),
                level: getZoneLevel(Math.floor(Math.random() * 100))
            }));
        }

        // è·å–åŒºåŸŸç­‰çº§
        function getZoneLevel(score) {
            if (score >= 80) return 'æœ€é€‚å®œ';
            if (score >= 60) return 'é€‚å®œ';
            if (score >= 40) return 'è¾ƒé€‚å®œ';
            return 'ä¸é€‚å®œ';
        }

        // æ˜¾ç¤ºæ¨¡æ‹ŸåŒºåˆ’ç»“æœ
        function displayMockZoningResults(cropType, precision) {
            console.log(`ğŸŒ¾ æ˜¾ç¤º${cropType}ä½œç‰©çš„æ¨¡æ‹ŸåŒºåˆ’ç»“æœ`);
            
            const mockZoning = {
                spatial_data: generateMockSpatialData(),
                statistics: {
                    optimal: { count: 15, percentage: 25, area: 3250 },
                    suitable: { count: 28, percentage: 35, area: 4800 },
                    marginal: { count: 22, percentage: 25, area: 3100 },
                    unsuitable: { count: 12, percentage: 15, area: 1850 }
                },
                zones: {
                    optimal: ['é•¿æ²™å¿', 'æµé˜³å¸‚', 'å®ä¹¡å¸‚', 'æœ›åŸåŒº', 'å²³éº“åŒº'],
                    suitable: ['æ ªæ´²å¿', 'æ¹˜æ½­å¿', 'è¡¡é˜³å¿', 'é‚µé˜³å¿', 'å²³é˜³å¿'],
                    marginal: ['å¸¸å¾·å¸‚', 'å¼ å®¶ç•Œå¸‚', 'ç›Šé˜³å¸‚', 'éƒ´å·å¸‚', 'æ°¸å·å¸‚'],
                    unsuitable: ['æ¹˜è¥¿å·', 'æ€€åŒ–å¸‚', 'å¨„åº•å¸‚']
                }
            };

            displayZoningResults(mockZoning);
        }

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°è°ƒæ•´åœ°å›¾
        window.addEventListener('resize', function() {
            if (distributionChart) {
                distributionChart.resize();
            }
        });
    </script>
</body>
</html>
