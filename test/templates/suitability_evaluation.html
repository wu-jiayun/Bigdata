<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§æ¤é€‚å®œæ€§è¯„ä»·æ¨¡å‹ - æ¹–å—çœå†œä¸šåˆ†æç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
        }
        .btn-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .factor-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .weight-slider {
            width: 100%;
        }
        .weight-display {
            font-weight: bold;
            color: #667eea;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
        }
        .btn-warning {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border: none;
        }
        .evaluation-result {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">ğŸŒ± ç§æ¤é€‚å®œæ€§è¯„ä»·æ¨¡å‹</span>
            <a href="/" class="btn btn-back">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- è¯„ä»·å› å­é…ç½® -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">ğŸ“Š è¯„ä»·å› å­é…ç½®</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>ğŸŒ¡ï¸ æ°”å€™å› å­</h6>
                        <div class="factor-item">
                            <label class="form-label">å¹´å¹³å‡æ¸©åº¦ (Â°C)</label>
                            <input type="range" class="form-range weight-slider" id="tempWeight" min="0" max="100" value="25">
                            <div class="d-flex justify-content-between">
                                <span>æƒé‡: <span class="weight-display" id="tempWeightDisplay">25%</span></span>
                                <div>
                                    <label>æœ€å°å€¼:</label>
                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width:80px;" id="tempMin" value="10">
                                    <label>æœ€å¤§å€¼:</label>
                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width:80px;" id="tempMax" value="25">
                                </div>
                            </div>
                        </div>

                        <div class="factor-item">
                            <label class="form-label">å†¬å­£æœ€ä½æ¸© (Â°C)</label>
                            <input type="range" class="form-range weight-slider" id="winterTempWeight" min="0" max="100" value="20">
                            <div class="d-flex justify-content-between">
                                <span>æƒé‡: <span class="weight-display" id="winterTempWeightDisplay">20%</span></span>
                                <div>
                                    <label>æœ€å°å€¼:</label>
                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width:80px;" id="winterTempMin" value="-5">
                                    <label>æœ€å¤§å€¼:</label>
                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width:80px;" id="winterTempMax" value="5">
                                </div>
                            </div>
                        </div>

                        <div class="factor-item">
                            <label class="form-label">å¹´é™æ°´é‡ (mm)</label>
                            <input type="range" class="form-range weight-slider" id="precipitationWeight" min="0" max="100" value="15">
                            <div class="d-flex justify-content-between">
                                <span>æƒé‡: <span class="weight-display" id="precipitationWeightDisplay">15%</span></span>
                                <div>
                                    <label>æœ€å°å€¼:</label>
                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width:80px;" id="precipitationMin" value="800">
                                    <label>æœ€å¤§å€¼:</label>
                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width:80px;" id="precipitationMax" value="1600">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6>ğŸ”ï¸ åœŸå£¤å› å­</h6>
                        <div class="factor-item">
                            <label class="form-label">åœŸå£¤pHå€¼</label>
                            <input type="range" class="form-range weight-slider" id="phWeight" min="0" max="100" value="25">
                            <div class="d-flex justify-content-between">
                                <span>æƒé‡: <span class="weight-display" id="phWeightDisplay">25%</span></span>
                                <div>
                                    <label>æœ€å°å€¼:</label>
                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width:80px;" id="phMin" value="6.0" step="0.1">
                                    <label>æœ€å¤§å€¼:</label>
                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width:80px;" id="phMax" value="7.5" step="0.1">
                                </div>
                            </div>
                        </div>

                        <div class="factor-item">
                            <label class="form-label">æœ‰æœºè´¨å«é‡ (%)</label>
                            <input type="range" class="form-range weight-slider" id="organicWeight" min="0" max="100" value="15">
                            <div class="d-flex justify-content-between">
                                <span>æƒé‡: <span class="weight-display" id="organicWeightDisplay">15%</span></span>
                                <div>
                                    <label>æœ€å°å€¼:</label>
                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width:80px;" id="organicMin" value="2.0" step="0.1">
                                    <label>æœ€å¤§å€¼:</label>
                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width:80px;" id="organicMax" value="4.0" step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <button class="btn btn-primary me-2" onclick="calculateSuitability()">ğŸ§® è®¡ç®—é€‚å®œæ€§è¯„ä»·</button>
                    <button class="btn btn-success me-2" onclick="resetWeights()">ğŸ”„ é‡ç½®æƒé‡</button>
                    <button class="btn btn-warning" onclick="saveModel()">ğŸ’¾ ä¿å­˜æ¨¡å‹</button>
                </div>
            </div>
        </div>

        <!-- è¯„ä»·ç»“æœæ˜¾ç¤º -->
        <div class="card" id="resultsCard" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">ğŸ“ˆ é€‚å®œæ€§è¯„ä»·ç»“æœ</h5>
            </div>
            <div class="card-body">
                <div class="evaluation-result" id="evaluationResult">
                    <!-- ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </div>
            </div>
        </div>

        <!-- ä½œç‰©é€‰æ‹©å’Œé¢„è®¾æ¨¡å‹ -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">ğŸŒ¾ ä½œç‰©é¢„è®¾æ¨¡å‹</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="loadCropModel('rice')">ğŸš æ°´ç¨»æ¨¡å‹</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100 mb-2" onclick="loadCropModel('corn')">ğŸŒ½ ç‰ç±³æ¨¡å‹</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100 mb-2" onclick="loadCropModel('soybean')">ğŸ«˜ å¤§è±†æ¨¡å‹</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-info w-100 mb-2" onclick="loadCropModel('wheat')">ğŸŒ¾ å°éº¦æ¨¡å‹</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('ğŸŒ± ç§æ¤é€‚å®œæ€§è¯„ä»·æ¨¡å‹é¡µé¢å¯åŠ¨');

        // æƒé‡æ»‘å—äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const sliders = document.querySelectorAll('.weight-slider');
            sliders.forEach(slider => {
                slider.addEventListener('input', function() {
                    updateWeightDisplay(this);
                    normalizeWeights();
                });
            });
            
            // åˆå§‹åŒ–æƒé‡æ˜¾ç¤º
            sliders.forEach(slider => updateWeightDisplay(slider));
        });

        // æ›´æ–°æƒé‡æ˜¾ç¤º
        function updateWeightDisplay(slider) {
            const displayId = slider.id + 'Display';
            const display = document.getElementById(displayId);
            if (display) {
                display.textContent = slider.value + '%';
            }
        }

        // æƒé‡å½’ä¸€åŒ–ï¼ˆç¡®ä¿æ€»å’Œä¸º100%ï¼‰
        function normalizeWeights() {
            const sliders = document.querySelectorAll('.weight-slider');
            let total = 0;
            
            sliders.forEach(slider => {
                total += parseInt(slider.value);
            });
            
            if (total !== 100) {
                const factor = 100 / total;
                sliders.forEach(slider => {
                    const newValue = Math.round(parseInt(slider.value) * factor);
                    slider.value = newValue;
                    updateWeightDisplay(slider);
                });
            }
        }

        // è®¡ç®—é€‚å®œæ€§è¯„ä»·
        async function calculateSuitability() {
            console.log('ğŸ§® å¼€å§‹è®¡ç®—é€‚å®œæ€§è¯„ä»·');
            
            // æ”¶é›†è¯„ä»·å› å­å’Œæƒé‡
            const factors = {
                temperature: {
                    weight: parseInt(document.getElementById('tempWeight').value),
                    min: parseFloat(document.getElementById('tempMin').value),
                    max: parseFloat(document.getElementById('tempMax').value)
                },
                winterTemp: {
                    weight: parseInt(document.getElementById('winterTempWeight').value),
                    min: parseFloat(document.getElementById('winterTempMin').value),
                    max: parseFloat(document.getElementById('winterTempMax').value)
                },
                precipitation: {
                    weight: parseInt(document.getElementById('precipitationWeight').value),
                    min: parseFloat(document.getElementById('precipitationMin').value),
                    max: parseFloat(document.getElementById('precipitationMax').value)
                },
                ph: {
                    weight: parseInt(document.getElementById('phWeight').value),
                    min: parseFloat(document.getElementById('phMin').value),
                    max: parseFloat(document.getElementById('phMax').value)
                },
                organic: {
                    weight: parseInt(document.getElementById('organicWeight').value),
                    min: parseFloat(document.getElementById('organicMin').value),
                    max: parseFloat(document.getElementById('organicMax').value)
                }
            };

            try {
                const response = await fetch('/api/suitability/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ factors: factors })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    displayResults(result.evaluation);
                    document.getElementById('resultsCard').style.display = 'block';
                    console.log('âœ… é€‚å®œæ€§è¯„ä»·è®¡ç®—æˆåŠŸ');
                } else {
                    alert('è¯„ä»·è®¡ç®—å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('âŒ é€‚å®œæ€§è¯„ä»·è¯·æ±‚å¼‚å¸¸:', error);
                alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // æ˜¾ç¤ºè¯„ä»·ç»“æœ
        function displayResults(evaluation) {
            const resultDiv = document.getElementById('evaluationResult');
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>ğŸ“Š ç»¼åˆé€‚å®œæ€§è¯„åˆ†</h6>
                        <div class="progress mb-3" style="height: 25px;">
                            <div class="progress-bar bg-success" style="width: ${evaluation.overall_score}%">
                                ${evaluation.overall_score.toFixed(1)}åˆ†
                            </div>
                        </div>
                        
                        <h6>ğŸ† é€‚å®œæ€§ç­‰çº§</h6>
                        <span class="badge ${getSuitabilityBadgeClass(evaluation.suitability_level)} fs-6">
                            ${evaluation.suitability_level}
                        </span>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>ğŸ“ˆ å„å› å­å¾—åˆ†</h6>
                        <ul class="list-unstyled">
            `;
            
            for (const [factor, score] of Object.entries(evaluation.factor_scores)) {
                html += `<li>â€¢ ${getFactorName(factor)}: <strong>${score.toFixed(1)}åˆ†</strong></li>`;
            }
            
            html += `
                        </ul>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>ğŸ’¡ ä¼˜åŒ–å»ºè®®</h6>
                    <div class="alert alert-info">
                        ${evaluation.recommendations.join('<br>â€¢ ')}
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
        }

        // è·å–é€‚å®œæ€§ç­‰çº§å¾½ç« æ ·å¼
        function getSuitabilityBadgeClass(level) {
            switch(level) {
                case 'æœ€é€‚å®œ': return 'bg-success';
                case 'é€‚å®œ': return 'bg-primary';
                case 'è¾ƒé€‚å®œ': return 'bg-warning';
                case 'ä¸é€‚å®œ': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // è·å–å› å­ä¸­æ–‡åç§°
        function getFactorName(factor) {
            const names = {
                'temperature': 'å¹´å¹³å‡æ¸©åº¦',
                'winterTemp': 'å†¬å­£æœ€ä½æ¸©',
                'precipitation': 'å¹´é™æ°´é‡',
                'ph': 'åœŸå£¤pHå€¼',
                'organic': 'æœ‰æœºè´¨å«é‡'
            };
            return names[factor] || factor;
        }

        // é‡ç½®æƒé‡
        function resetWeights() {
            document.getElementById('tempWeight').value = 25;
            document.getElementById('winterTempWeight').value = 20;
            document.getElementById('precipitationWeight').value = 15;
            document.getElementById('phWeight').value = 25;
            document.getElementById('organicWeight').value = 15;
            
            const sliders = document.querySelectorAll('.weight-slider');
            sliders.forEach(slider => updateWeightDisplay(slider));
            
            console.log('ğŸ”„ æƒé‡å·²é‡ç½®');
        }

        // ä¿å­˜æ¨¡å‹
        function saveModel() {
            const modelData = {
                name: prompt('è¯·è¾“å…¥æ¨¡å‹åç§°:'),
                factors: {
                    temperature: {
                        weight: parseInt(document.getElementById('tempWeight').value),
                        min: parseFloat(document.getElementById('tempMin').value),
                        max: parseFloat(document.getElementById('tempMax').value)
                    },
                    // ... å…¶ä»–å› å­
                }
            };
            
            if (modelData.name) {
                localStorage.setItem('suitability_model_' + modelData.name, JSON.stringify(modelData));
                alert('æ¨¡å‹å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                console.log('ğŸ’¾ æ¨¡å‹ä¿å­˜æˆåŠŸ:', modelData.name);
            }
        }

        // åŠ è½½ä½œç‰©é¢„è®¾æ¨¡å‹
        function loadCropModel(cropType) {
            const models = {
                rice: {
                    tempWeight: 30, tempMin: 20, tempMax: 30,
                    winterTempWeight: 15, winterTempMin: -2, winterTempMax: 8,
                    precipitationWeight: 25, precipitationMin: 1000, precipitationMax: 1800,
                    phWeight: 20, phMin: 6.0, phMax: 7.0,
                    organicWeight: 10, organicMin: 2.5, organicMax: 4.5
                },
                corn: {
                    tempWeight: 25, tempMin: 18, tempMax: 28,
                    winterTempWeight: 10, winterTempMin: -10, winterTempMax: 5,
                    precipitationWeight: 30, precipitationMin: 600, precipitationMax: 1200,
                    phWeight: 25, phMin: 6.5, phMax: 7.5,
                    organicWeight: 10, organicMin: 2.0, organicMax: 4.0
                },
                soybean: {
                    tempWeight: 20, tempMin: 15, tempMax: 25,
                    winterTempWeight: 15, winterTempMin: -5, winterTempMax: 5,
                    precipitationWeight: 25, precipitationMin: 500, precipitationMax: 1000,
                    phWeight: 30, phMin: 6.2, phMax: 7.2,
                    organicWeight: 10, organicMin: 1.8, organicMax: 3.5
                },
                wheat: {
                    tempWeight: 25, tempMin: 12, tempMax: 22,
                    winterTempWeight: 25, winterTempMin: -8, winterTempMax: 3,
                    precipitationWeight: 20, precipitationMin: 400, precipitationMax: 800,
                    phWeight: 20, phMin: 6.8, phMax: 7.8,
                    organicWeight: 10, organicMin: 2.2, organicMax: 3.8
                }
            };

            const model = models[cropType];
            if (model) {
                // è®¾ç½®æƒé‡
                Object.keys(model).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = model[key];
                        if (key.includes('Weight')) {
                            updateWeightDisplay(element);
                        }
                    }
                });
                
                console.log(`ğŸŒ¾ å·²åŠ è½½${cropType}ä½œç‰©æ¨¡å‹`);
                alert(`å·²åŠ è½½${getCropName(cropType)}ç§æ¤é€‚å®œæ€§æ¨¡å‹`);
            }
        }

        // è·å–ä½œç‰©ä¸­æ–‡åç§°
        function getCropName(cropType) {
            const names = {
                'rice': 'æ°´ç¨»',
                'corn': 'ç‰ç±³', 
                'soybean': 'å¤§è±†',
                'wheat': 'å°éº¦'
            };
            return names[cropType] || cropType;
        }
    </script>
</body>
</html>
