<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœŸå£¤åˆ†æ - æ¹–å—çœå†œä¸šåˆ†æç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .chart-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .chart-container {
            width: 100%;
            height: 400px;
        }
        .btn-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">ğŸ”ï¸ åœŸå£¤åˆ†æ</span>
            <a href="/" class="btn btn-back">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- åœŸå£¤ç±»å‹åˆ†å¸ƒ -->
        <div class="chart-card">
            <h5 class="card-title">ğŸ¥§ åœŸå£¤ç±»å‹åˆ†å¸ƒ</h5>
            <div id="soilTypeChart" class="chart-container"></div>
        </div>

        <!-- pHå€¼åˆ†å¸ƒ -->
        <div class="chart-card">
            <h5 class="card-title">ğŸ“Š pHå€¼åˆ†å¸ƒç»Ÿè®¡</h5>
            <div id="phDistChart" class="chart-container"></div>
        </div>

        <!-- å¿å¸‚åœŸå£¤è´¨é‡æ’å -->
        <div class="chart-card">
            <h5 class="card-title">ğŸ† å¿å¸‚åœŸå£¤è´¨é‡æ’å</h5>
            <div id="qualityRankChart" class="chart-container"></div>
        </div>
    </div>

    <script>
        console.log('ğŸ”ï¸ åœŸå£¤åˆ†æé¡µé¢å¯åŠ¨');

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            console.log('ğŸ“Š åˆå§‹åŒ–åœŸå£¤åˆ†æå›¾è¡¨');
            
            const soilTypeChart = echarts.init(document.getElementById('soilTypeChart'));
            const phDistChart = echarts.init(document.getElementById('phDistChart'));
            const qualityRankChart = echarts.init(document.getElementById('qualityRankChart'));
            
            return { soilTypeChart, phDistChart, qualityRankChart };
        }

        // åŠ è½½åœŸå£¤æ•°æ®
        async function loadSoilData() {
            console.log('ğŸ”„ åŠ è½½åœŸå£¤æ•°æ®');
            
            try {
                const response = await fetch('/api/echarts/soil_analysis');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const charts = initCharts();
                    
                    // è®¾ç½®åœŸå£¤ç±»å‹åˆ†å¸ƒ
                    if (result.charts.soil_type_pie) {
                        const soilData = result.charts.soil_type_pie;
                        charts.soilTypeChart.setOption({
                            title: { text: soilData.title, left: 'center' },
                            tooltip: { 
                                trigger: 'item',
                                formatter: '{a} <br/>{b}: {c} ({d}%)'
                            },
                            legend: { 
                                orient: 'vertical', 
                                left: 'left'
                            },
                            series: [{
                                name: 'åœŸå£¤ç±»å‹',
                                type: 'pie',
                                radius: '60%',
                                data: soilData.data,
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                }
                            }]
                        });
                        console.log('âœ… åœŸå£¤ç±»å‹å›¾è¡¨åŠ è½½æˆåŠŸ');
                    }
                    
                    // è®¾ç½®pHåˆ†å¸ƒ
                    if (result.charts.ph_distribution) {
                        const phData = result.charts.ph_distribution;
                        charts.phDistChart.setOption({
                            title: { text: phData.title, left: 'center' },
                            tooltip: { trigger: 'axis' },
                            xAxis: { 
                                type: 'category',
                                data: phData.xAxis
                            },
                            yAxis: { 
                                type: 'value',
                                name: 'æ ·æœ¬æ•°é‡'
                            },
                            series: phData.series
                        });
                        console.log('âœ… pHåˆ†å¸ƒå›¾è¡¨åŠ è½½æˆåŠŸ');
                    }
                    
                    // è®¾ç½®å¿å¸‚è´¨é‡æ’å
                    if (result.charts.county_quality_ranking) {
                        const qualityData = result.charts.county_quality_ranking;
                        charts.qualityRankChart.setOption({
                            title: { text: qualityData.title, left: 'center' },
                            tooltip: { trigger: 'axis' },
                            xAxis: { 
                                type: 'category',
                                data: qualityData.xAxis,
                                axisLabel: { rotate: 45 }
                            },
                            yAxis: { 
                                type: 'value',
                                name: 'è´¨é‡è¯„åˆ†'
                            },
                            series: qualityData.series
                        });
                        console.log('âœ… å¿å¸‚è´¨é‡æ’åå›¾è¡¨åŠ è½½æˆåŠŸ');
                    }
                    
                } else {
                    console.error('âŒ åœŸå£¤æ•°æ®åŠ è½½å¤±è´¥:', result.message);
                    alert('åœŸå£¤æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·å…ˆè¿è¡Œç³»ç»Ÿåˆ†æ');
                }
            } catch (error) {
                console.error('âŒ åœŸå£¤æ•°æ®è¯·æ±‚å¼‚å¸¸:', error);
                alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ åœŸå£¤åˆ†æé¡µé¢åŠ è½½å®Œæˆ');
            
            // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œç¡®ä¿EChartså®Œå…¨åŠ è½½
            setTimeout(loadSoilData, 1000);
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', function() {
            const charts = document.querySelectorAll('.chart-container');
            charts.forEach(container => {
                const chart = echarts.getInstanceByDom(container);
                if (chart) {
                    chart.resize();
                }
            });
        });
    </script>
</body>
</html>
