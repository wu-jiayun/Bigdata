<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²ƒåœŸè§„åˆ’å¸ˆ - Sparkå†œä¸šåˆ†æç³»ç»Ÿ</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    {% include 'components/navbar.html' %}

    <div class="container-fluid mt-4">
        <!-- æ§åˆ¶é¢æ¿ -->
        {% include 'components/control-panel.html' %}

        <!-- å¯¼èˆªæ ‡ç­¾ -->
        {% include 'components/chart-tabs.html' %}

        <!-- åˆ†æç»“æœå†…å®¹ -->
        {% include 'components/chart-content.html' %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- æ¨¡å—åŒ–JavaScript - æŒ‰ä¾èµ–é¡ºåºåŠ è½½ -->
    <script>
        // ç¡®ä¿æ¨¡å—æŒ‰æ­£ç¡®é¡ºåºåŠ è½½
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // æŒ‰é¡ºåºåŠ è½½æ‰€æœ‰æ¨¡å—
        async function loadAllModules() {
            try {
                console.log('ğŸ”„ å¼€å§‹æŒ‰é¡ºåºåŠ è½½JavaScriptæ¨¡å—...');
                
                await loadScript("{{ url_for('static', filename='js/core.js') }}");
                console.log('âœ… core.js åŠ è½½å®Œæˆ');
                
                await loadScript("{{ url_for('static', filename='js/system-control.js') }}");
                console.log('âœ… system-control.js åŠ è½½å®Œæˆ');
                
                await loadScript("{{ url_for('static', filename='js/chart-loader.js') }}");
                console.log('âœ… chart-loader.js åŠ è½½å®Œæˆ');
                
                await loadScript("{{ url_for('static', filename='js/soil-charts.js') }}");
                console.log('âœ… soil-charts.js åŠ è½½å®Œæˆ');
                
                await loadScript("{{ url_for('static', filename='js/crop-charts.js') }}");
                console.log('âœ… crop-charts.js åŠ è½½å®Œæˆ');
                
                await loadScript("{{ url_for('static', filename='js/zoning-charts.js') }}");
                console.log('âœ… zoning-charts.js åŠ è½½å®Œæˆ');
                
                await loadScript("{{ url_for('static', filename='js/app.js') }}");
                console.log('âœ… app.js åŠ è½½å®Œæˆ');
                
                console.log('ğŸ‰ æ‰€æœ‰JavaScriptæ¨¡å—åŠ è½½å®Œæˆï¼');
                
                // éªŒè¯æ¨¡å—æ˜¯å¦æ­£ç¡®åŠ è½½
                console.log('ğŸ” éªŒè¯æ¨¡å—åŠ è½½çŠ¶æ€:', {
                    SparkCore: !!window.SparkCore,
                    SystemControl: !!window.SystemControl,
                    ChartLoader: !!window.ChartLoader,
                    echarts: typeof echarts !== 'undefined'
                });
                
                // æ‰‹åŠ¨è§¦å‘åˆå§‹åŒ–ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
                if (window.SparkCore && window.SystemControl) {
                    console.log('ğŸ”§ æ‰‹åŠ¨è§¦å‘äº‹ä»¶ç»‘å®š...');
                    setTimeout(() => {
                        const initBtn = document.getElementById('initSystemBtn');
                        const runBtn = document.getElementById('runAnalysisBtn');
                        
                        if (initBtn && !initBtn.onclick) {
                            console.log('ğŸ”— æ‰‹åŠ¨ç»‘å®šåˆå§‹åŒ–æŒ‰é’®');
                            initBtn.onclick = function() {
                                console.log('ğŸš€ æ‰‹åŠ¨ç»‘å®šçš„åˆå§‹åŒ–æŒ‰é’®è¢«ç‚¹å‡»');
                                window.SystemControl.initializeSystem();
                            };
                        }
                        
                        if (runBtn && !runBtn.onclick) {
                            console.log('ğŸ”— æ‰‹åŠ¨ç»‘å®šåˆ†ææŒ‰é’®');
                            runBtn.onclick = function() {
                                console.log('ğŸ”¬ æ‰‹åŠ¨ç»‘å®šçš„åˆ†ææŒ‰é’®è¢«ç‚¹å‡»');
                                window.SystemControl.runAnalysis();
                            };
                        }
                    }, 500);
                }
                
            } catch (error) {
                console.error('âŒ æ¨¡å—åŠ è½½å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹åŠ è½½æ¨¡å—
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadAllModules);
        } else {
            loadAllModules();
        }
    </script>
</body>
</html>
