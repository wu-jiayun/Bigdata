<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œç‰©åˆ†æ - æ¹–å—çœå†œä¸šåˆ†æç³»ç»Ÿ</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .chart-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .chart-container {
            width: 100%;
            height: 400px;
        }
        .btn-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand">ğŸŒ¾ ä½œç‰©åˆ†æ</span>
            <a href="/" class="btn btn-back">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ä½œç‰©åˆ†ç±»åˆ†å¸ƒ -->
        <div class="chart-card">
            <h5 class="card-title">ğŸ¥§ ä½œç‰©åˆ†ç±»åˆ†å¸ƒ</h5>
            <div id="cropCategoryChart" class="chart-container"></div>
        </div>

        <!-- ä½œç‰©æ¸©åº¦éœ€æ±‚ -->
        <div class="chart-card">
            <h5 class="card-title">ğŸŒ¡ï¸ ä½œç‰©æ¸©åº¦éœ€æ±‚èŒƒå›´</h5>
            <div id="cropTempChart" class="chart-container"></div>
        </div>

        <!-- ä½œç‰©pHé€‚åº”æ€§ -->
        <div class="chart-card">
            <h5 class="card-title">âš–ï¸ ä½œç‰©pHé€‚åº”æ€§åˆ†å¸ƒ</h5>
            <div id="cropPhChart" class="chart-container"></div>
        </div>
    </div>

    <script>
        console.log('ğŸŒ¾ ä½œç‰©åˆ†æé¡µé¢å¯åŠ¨');

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            console.log('ğŸ“Š åˆå§‹åŒ–ä½œç‰©åˆ†æå›¾è¡¨');
            
            const cropCategoryChart = echarts.init(document.getElementById('cropCategoryChart'));
            const cropTempChart = echarts.init(document.getElementById('cropTempChart'));
            const cropPhChart = echarts.init(document.getElementById('cropPhChart'));
            
            return { cropCategoryChart, cropTempChart, cropPhChart };
        }

        // åŠ è½½ä½œç‰©æ•°æ®
        async function loadCropData() {
            console.log('ğŸ”„ åŠ è½½ä½œç‰©æ•°æ®');
            
            try {
                const response = await fetch('/api/echarts/crop_suitability');
                const result = await response.json();
                
                if (result.status === 'success') {
                    const charts = initCharts();
                    
                    // è®¾ç½®ä½œç‰©åˆ†ç±»åˆ†å¸ƒ
                    if (result.charts.suitability_distribution) {
                        const categoryData = result.charts.suitability_distribution;
                        charts.cropCategoryChart.setOption({
                            title: { text: categoryData.title, left: 'center' },
                            tooltip: { 
                                trigger: 'item',
                                formatter: '{a} <br/>{b}: {c}ç§ ({d}%)'
                            },
                            legend: { 
                                orient: 'vertical', 
                                left: 'left'
                            },
                            series: [{
                                name: 'ä½œç‰©åˆ†ç±»',
                                type: 'pie',
                                radius: '60%',
                                data: categoryData.data,
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                }
                            }]
                        });
                        console.log('âœ… ä½œç‰©åˆ†ç±»å›¾è¡¨åŠ è½½æˆåŠŸ');
                    }
                    
                    // è®¾ç½®ä½œç‰©æ¸©åº¦éœ€æ±‚
                    if (result.charts.crop_advantages_radar) {
                        const tempData = result.charts.crop_advantages_radar;
                        charts.cropTempChart.setOption({
                            title: { text: tempData.title, left: 'center' },
                            tooltip: { trigger: 'axis' },
                            legend: { data: tempData.series ? tempData.series.map(s => s.name) : [] },
                            xAxis: { 
                                type: 'category',
                                data: tempData.xAxis
                            },
                            yAxis: { 
                                type: 'value',
                                name: 'æ¸©åº¦(Â°C)'
                            },
                            series: tempData.series
                        });
                        console.log('âœ… ä½œç‰©æ¸©åº¦éœ€æ±‚å›¾è¡¨åŠ è½½æˆåŠŸ');
                    }
                    
                    // è®¾ç½®ä½œç‰©pHé€‚åº”æ€§
                    if (result.charts.limiting_factors_pie) {
                        const phData = result.charts.limiting_factors_pie;
                        charts.cropPhChart.setOption({
                            title: { text: phData.title, left: 'center' },
                            tooltip: { 
                                trigger: 'item',
                                formatter: '{a} <br/>{b}: {c}ç§ä½œç‰© ({d}%)'
                            },
                            legend: { 
                                orient: 'vertical', 
                                left: 'left'
                            },
                            series: [{
                                name: 'ä½œç‰©pHé€‚åº”æ€§',
                                type: 'pie',
                                radius: '60%',
                                data: phData.data,
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                    }
                                }
                            }]
                        });
                        console.log('âœ… ä½œç‰©pHé€‚åº”æ€§å›¾è¡¨åŠ è½½æˆåŠŸ');
                    }
                    
                } else {
                    console.error('âŒ ä½œç‰©æ•°æ®åŠ è½½å¤±è´¥:', result.message);
                    alert('ä½œç‰©æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·å…ˆè¿è¡Œç³»ç»Ÿåˆ†æ');
                }
            } catch (error) {
                console.error('âŒ ä½œç‰©æ•°æ®è¯·æ±‚å¼‚å¸¸:', error);
                alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ ä½œç‰©åˆ†æé¡µé¢åŠ è½½å®Œæˆ');
            
            // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œç¡®ä¿EChartså®Œå…¨åŠ è½½
            setTimeout(loadCropData, 1000);
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶è°ƒæ•´å›¾è¡¨
        window.addEventListener('resize', function() {
            const charts = document.querySelectorAll('.chart-container');
            charts.forEach(container => {
                const chart = echarts.getInstanceByDom(container);
                if (chart) {
                    chart.resize();
                }
            });
        });
    </script>
</body>
</html>
